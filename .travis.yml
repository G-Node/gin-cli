language: go

dist: trusty
sudo: required

services:
    - docker

matrix:
  include:
    - go: "1.10.x"
      env: testscript="run-cont-tests"
    - go: "1.10.x"
      env: testscript="run-cont-tests-mv"
    - go: tip
  allow_failures:
    - go: tip

before_install:
  - sudo apt-get update

install:
  # tools
  - go get github.com/golang/lint/golint
  # dependencies
  - go get github.com/spf13/viper
  - go get github.com/spf13/cobra
  - go get github.com/howeyc/gopass
  - go get golang.org/x/crypto/ssh
  - go get github.com/G-Node/gin-core/gin
  - go get github.com/G-Node/gin-repo/wire
  - go get golang.org/x/crypto/ssh
  - go get github.com/gogits/go-gogs-client
  - go get github.com/fatih/color
  - go get github.com/hashicorp/go-version
  - go get github.com/shibukawa/configdir
  - go get github.com/bbrks/wrap
  - go get github.com/docker/docker/pkg/term
  - go get github.com/dustin/go-humanize
  - go get github.com/alecthomas/template
  # import path symlink for forks
  - if [ ! -d ${GOPATH}/src/github.com/G-Node/gin-cli ]; then ln -vs $(pwd) ${GOPATH}/src/github.com/G-Node/gin-cli; fi
  - go vet ./...
  - gofmt -s -l .
  - golint github.com/G-Node/gin-cli...

script:
  - make
  - make installtest
  - if [[ "${TRAVIS_GO_VERSION}" != "tip" ]]; then
        ./tests/start-server;
        while ! curl localhost:3000 -so /dev/null; do sleep 1; done;
        ./tests/${testscript};
    fi

after_script:
  # push logs to gist
  - if [[ "${TRAVIS_GO_VERSION}" != "tip" ]]; then
        echo $GISTTOKEN > ./tests/testuserhome/.gist;
        mv ./tests/testuserhome/log/gin.log ./tests/testuserhome/log/gin-${TRAVIS_BRANCH}-${testscript}.log;
        mv ./tests/testuserhome/log/tests.log ./tests/testuserhome/log/tests-${TRAVIS_BRANCH}-${testscript}.log;
        ./tests/run-cont gist -u 59e3b1c2fc3ff525127f9b3af81e7f4c ./testuserhome/log/*.log;
        rm ./tests/testuserhome/.gist;
    fi
