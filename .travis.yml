language: go

dist: xenial

services:
    - docker

env:
  global:
    - GO111MODULE=on


# Three builds:
# - Build with latest stable Go and run tests
# - Build with latest stable Go and run tests with the minimum supported version of Git-annex
# - Build with Go 'tip' (devel version).  This is allowed to fail.  It's meant to catch upcoming build, lint, and vet errors early.
matrix:
  include:
    - go: "1.11.x"
      env: testscript="run-cont-tests"
    # - go: "1.11.x"
    #   env: testscript="run-cont-tests-mv"
    - go: tip
  allow_failures:
    - go: tip

install:
  - go get -v ./...
  # tools
  # - go get -u golang.org/x/lint/golint
  # codestyle checks
  - go vet ./...
  # - golint ./...
  - gofmt -s -l .

script:
  - make
  - make testbuild
  - if [[ "${TRAVIS_GO_VERSION}" != "tip" ]]; then
        ./tests/start-server;
        while ! curl localhost:3000 -so /dev/null; do sleep 1; done;
        ./tests/${testscript};
    fi
