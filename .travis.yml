language: go

dist: trusty
sudo: required

go:
  - 1.7
  - tip

before_install:
  - sudo apt-get update
  - sudo apt-get install git-annex

install:
  # import path fix for forks
  - if [ ! -d ${GOPATH}/src/github.com/G-Node/gin-cli ]; then ln -s $srcdir ${GOPATH}/src/github.com/G-Node/gin-cli; fi
  # tools
  - go get github.com/golang/lint/golint
  - go get github.com/GeertJohan/fgt
  # libgit2 from sauce
  - srcdir=$(pwd)
  - wget -O libgit2.tar.gz -o /dev/null https://github.com/libgit2/libgit2/archive/v0.24.6.tar.gz && tar xzf libgit2.tar.gz && cd libgit2-0.24.6 && mkdir build && cd build && cmake .. && sudo cmake --build . --target install && sudo ldconfig
  - cd $srcdir
  # gin-cli deps
  - go get -v ./...
  # coveralls
  - go get github.com/mattn/goveralls
  - go get golang.org/x/tools/cmd/cover

script:
  - go vet ./...
  - go test -v ./...

after_success:
  - if [ $TRAVIS_GO_VERSION == "tip" ]; then exit 0; fi
  # run tests again individually and generate coverage profiles
  - find -iname "*test.go" -execdir [ ! -e covprof.part ] \; -execdir go test -v -covermode=count -coverprofile=covprof.part \;
  - "echo \"mode: count\" > profile.cov"
  - "grep -h -v -F \"mode: count\" --include=covprof.part -r . >> profile.cov"
  # upload coverage profile
  - goveralls -coverprofile=profile.cov -service=travis-ci
