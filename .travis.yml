language: go

dist: trusty
sudo: required

services:
    - docker

go:
  - "1.10.x"
  - tip

matrix:
    allow_failures:
        - go: tip

before_install:
  - sudo apt-get update

install:
  # tools
  - go get github.com/golang/lint/golint
  - go get github.com/GeertJohan/fgt
  # coveralls
  - go get github.com/mattn/goveralls
  - go get golang.org/x/tools/cmd/cover
  # dependencies
  - go get github.com/spf13/viper
  - go get github.com/spf13/cobra
  - go get github.com/howeyc/gopass
  - go get golang.org/x/crypto/ssh
  - go get github.com/G-Node/gin-core/gin
  - go get github.com/G-Node/gin-repo/wire
  - go get golang.org/x/crypto/ssh
  - go get github.com/gogits/go-gogs-client
  - go get github.com/fatih/color
  - go get github.com/hashicorp/go-version
  - go get github.com/shibukawa/configdir
  - go get github.com/bbrks/wrap
  - go get github.com/docker/docker/pkg/term
  # import path symlink for forks
  - if [ ! -d ${GOPATH}/src/github.com/G-Node/gin-cli ]; then ln -vs $(pwd) ${GOPATH}/src/github.com/G-Node/gin-cli; fi

script:
  - make
  - make installtest
  - if [ ${TRAVIS_GO_VERSION} != "tip" ]; then
        ./tests/start-server.sh;
        while ! curl localhost:3000 -so /dev/null; do sleep 1; done;
        ./tests/run-cont-tests.sh;
    fi

after_script:
  # push logs to gist
  - if [ ${TRAVIS_GO_VERSION} != "tip" ]; then
        echo $GISTTOKEN > ./tests/testuserhome/.gist;
        mv ./scripts/log/gin.log ./scripts/log/gin-${TRAVIS_BRANCH}.log;
        mv ./scripts/log/tests.log ./scripts/log/tests-${TRAVIS_BRANCH}.log;
        ./tests/run-cont.sh gist -u 59e3b1c2fc3ff525127f9b3af81e7f4c ./scripts/log/*.log;
        rm ./tests/testuserhome/.gist;
    fi
